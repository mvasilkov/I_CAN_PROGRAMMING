var convnetjs=convnetjs||{REVISION:"ALPHA"};!function(t){"use strict";function s(t,s){if(!t){if(s=s||"Assertion failed","undefined"!=typeof Error)throw new Error(s);throw s}}var e=!1,i=0,a=function(){if(e)return e=!1,i;var t=2*Math.random()-1,s=2*Math.random()-1,r=t*t+s*s;if(0==r||r>1)return a();var h=Math.sqrt(-2*Math.log(r)/r);return i=s*h,e=!0,t*h},r=function(t,s){return Math.random()*(s-t)+t},h=function(t,s){return Math.floor(Math.random()*(s-t)+t)},n=function(t,s){return t+a()*s},o=function(t){if("undefined"==typeof t||isNaN(t))return[];if("undefined"==typeof ArrayBuffer){for(var s=new Array(t),e=0;t>e;e++)s[e]=0;return s}return new Float64Array(t)},u=function(t,s){for(var e=0,i=t.length;i>e;e++)if(t[e]===s)return!0;return!1},_=function(t){for(var s=[],e=0,i=t.length;i>e;e++)u(s,t[e])||s.push(t[e]);return s},d=function(t){if(0===t.length)return{};for(var s=t[0],e=t[0],i=0,a=0,r=t.length,h=1;r>h;h++)t[h]>s&&(s=t[h],i=h),t[h]<e&&(e=t[h],a=h);return{maxi:i,maxv:s,mini:a,minv:e,dv:s-e}},p=function(t){for(var s,e=t,i=0,a=[],r=0;t>r;r++)a[r]=r;for(;e--;)i=Math.floor(Math.random()*(e+1)),s=a[e],a[e]=a[i],a[i]=s;return a},f=function(t,s){for(var e=r(0,1),i=0,a=0,h=t.length;h>a;a++)if(i+=s[a],i>e)return t[a]},l=function(t,s,e){if("string"==typeof s)return"undefined"!=typeof t[s]?t[s]:e;for(var i=e,a=0;a<s.length;a++){var r=s[a];"undefined"!=typeof t[r]&&(i=t[r])}return i};t.randf=r,t.randi=h,t.randn=n,t.zeros=o,t.maxmin=d,t.randperm=p,t.weightedSample=f,t.arrUnique=_,t.arrContains=u,t.getopt=l,t.assert=s}(convnetjs),function(t){"use strict";var s=function(s,e,i,a){if("[object Array]"===Object.prototype.toString.call(s)){this.sx=1,this.sy=1,this.depth=s.length,this.w=t.zeros(this.depth),this.dw=t.zeros(this.depth);for(var r=0;r<this.depth;r++)this.w[r]=s[r]}else{this.sx=s,this.sy=e,this.depth=i;var h=s*e*i;if(this.w=t.zeros(h),this.dw=t.zeros(h),"undefined"==typeof a)for(var n=Math.sqrt(1/(s*e*i)),r=0;h>r;r++)this.w[r]=t.randn(0,n);else for(var r=0;h>r;r++)this.w[r]=a}};s.prototype={get:function(t,s,e){var i=(this.sx*s+t)*this.depth+e;return this.w[i]},set:function(t,s,e,i){var a=(this.sx*s+t)*this.depth+e;this.w[a]=i},add:function(t,s,e,i){var a=(this.sx*s+t)*this.depth+e;this.w[a]+=i},get_grad:function(t,s,e){var i=(this.sx*s+t)*this.depth+e;return this.dw[i]},set_grad:function(t,s,e,i){var a=(this.sx*s+t)*this.depth+e;this.dw[a]=i},add_grad:function(t,s,e,i){var a=(this.sx*s+t)*this.depth+e;this.dw[a]+=i},cloneAndZero:function(){return new s(this.sx,this.sy,this.depth,0)},clone:function(){for(var t=new s(this.sx,this.sy,this.depth,0),e=this.w.length,i=0;e>i;i++)t.w[i]=this.w[i];return t},addFrom:function(t){for(var s=0;s<this.w.length;s++)this.w[s]+=t.w[s]},addFromScaled:function(t,s){for(var e=0;e<this.w.length;e++)this.w[e]+=s*t.w[e]},setConst:function(t){for(var s=0;s<this.w.length;s++)this.w[s]=t},toJSON:function(){var t={};return t.sx=this.sx,t.sy=this.sy,t.depth=this.depth,t.w=this.w,t},fromJSON:function(s){this.sx=s.sx,this.sy=s.sy,this.depth=s.depth;var e=this.sx*this.sy*this.depth;this.w=t.zeros(e),this.dw=t.zeros(e);for(var i=0;e>i;i++)this.w[i]=s.w[i]}},t.Vol=s}(convnetjs),function(t){"use strict";var s=t.Vol,e=function(e,i,a,r,h){if("undefined"==typeof h)var h=!1;if("undefined"==typeof a)var a=t.randi(0,e.sx-i);if("undefined"==typeof r)var r=t.randi(0,e.sy-i);var n;if(i!==e.sx||0!==a||0!==r){n=new s(i,i,e.depth,0);for(var o=0;i>o;o++)for(var u=0;i>u;u++)if(!(0>o+a||o+a>=e.sx||0>u+r||u+r>=e.sy))for(var _=0;_<e.depth;_++)n.set(o,u,_,e.get(o+a,u+r,_))}else n=e;if(h){for(var d=n.cloneAndZero(),o=0;o<n.sx;o++)for(var u=0;u<n.sy;u++)for(var _=0;_<n.depth;_++)d.set(o,u,_,n.get(n.sx-o-1,u,_));n=d}return n},i=function(t,e){if("undefined"==typeof e)var e=!1;var i=document.createElement("canvas");i.width=t.width,i.height=t.height;var a=i.getContext("2d");try{a.drawImage(t,0,0)}catch(r){if("NS_ERROR_NOT_AVAILABLE"===r.name)return!1;throw r}try{var h=a.getImageData(0,0,i.width,i.height)}catch(r){if("IndexSizeError"===r.name)return!1;throw r}for(var n=h.data,o=t.width,u=t.height,_=[],d=0;d<n.length;d++)_.push(n[d]/255-.5);var p=new s(o,u,4,0);if(p.w=_,e){for(var f=new s(o,u,1,0),d=0;o>d;d++)for(var l=0;u>l;l++)f.set(d,l,0,p.get(d,l,0));p=f}return p};t.augment=e,t.img_to_vol=i}(convnetjs),function(t){"use strict";var s=t.Vol,e=function(t){var t=t||{};this.out_depth=t.filters,this.sx=t.sx,this.in_depth=t.in_depth,this.in_sx=t.in_sx,this.in_sy=t.in_sy,this.sy="undefined"!=typeof t.sy?t.sy:this.sx,this.stride="undefined"!=typeof t.stride?t.stride:1,this.pad="undefined"!=typeof t.pad?t.pad:0,this.l1_decay_mul="undefined"!=typeof t.l1_decay_mul?t.l1_decay_mul:0,this.l2_decay_mul="undefined"!=typeof t.l2_decay_mul?t.l2_decay_mul:1,this.out_sx=Math.floor((this.in_sx+2*this.pad-this.sx)/this.stride+1),this.out_sy=Math.floor((this.in_sy+2*this.pad-this.sy)/this.stride+1),this.layer_type="conv";var e="undefined"!=typeof t.bias_pref?t.bias_pref:0;this.filters=[];for(var i=0;i<this.out_depth;i++)this.filters.push(new s(this.sx,this.sy,this.in_depth));this.biases=new s(1,1,this.out_depth,e)};e.prototype={forward:function(t,e){this.in_act=t;for(var i=new s(0|this.out_sx,0|this.out_sy,0|this.out_depth,0),a=0|t.sx,r=0|t.sy,h=0|this.stride,n=0;n<this.out_depth;n++)for(var o=this.filters[n],u=0|-this.pad,_=0|-this.pad,d=0;d<this.out_sy;_+=h,d++){u=0|-this.pad;for(var p=0;p<this.out_sx;u+=h,p++){for(var f=0,l=0;l<o.sy;l++)for(var y=_+l,c=0;c<o.sx;c++){var m=u+c;if(y>=0&&r>y&&m>=0&&a>m)for(var v=0;v<o.depth;v++)f+=o.w[(o.sx*l+c)*o.depth+v]*t.w[(a*y+m)*t.depth+v]}f+=this.biases.w[n],i.set(p,d,n,f)}}return this.out_act=i,this.out_act},backward:function(){var s=this.in_act;s.dw=t.zeros(s.w.length);for(var e=0|s.sx,i=0|s.sy,a=0|this.stride,r=0;r<this.out_depth;r++)for(var h=this.filters[r],n=0|-this.pad,o=0|-this.pad,u=0;u<this.out_sy;o+=a,u++){n=0|-this.pad;for(var _=0;_<this.out_sx;n+=a,_++){for(var d=this.out_act.get_grad(_,u,r),p=0;p<h.sy;p++)for(var f=o+p,l=0;l<h.sx;l++){var y=n+l;if(f>=0&&i>f&&y>=0&&e>y)for(var c=0;c<h.depth;c++){var m=(e*f+y)*s.depth+c,v=(h.sx*p+l)*h.depth+c;h.dw[v]+=s.w[m]*d,s.dw[m]+=h.w[v]*d}}this.biases.dw[r]+=d}}},getParamsAndGrads:function(){for(var t=[],s=0;s<this.out_depth;s++)t.push({params:this.filters[s].w,grads:this.filters[s].dw,l2_decay_mul:this.l2_decay_mul,l1_decay_mul:this.l1_decay_mul});return t.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0}),t},toJSON:function(){var t={};t.sx=this.sx,t.sy=this.sy,t.stride=this.stride,t.in_depth=this.in_depth,t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.l1_decay_mul=this.l1_decay_mul,t.l2_decay_mul=this.l2_decay_mul,t.pad=this.pad,t.filters=[];for(var s=0;s<this.filters.length;s++)t.filters.push(this.filters[s].toJSON());return t.biases=this.biases.toJSON(),t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.sx=t.sx,this.sy=t.sy,this.stride=t.stride,this.in_depth=t.in_depth,this.filters=[],this.l1_decay_mul="undefined"!=typeof t.l1_decay_mul?t.l1_decay_mul:1,this.l2_decay_mul="undefined"!=typeof t.l2_decay_mul?t.l2_decay_mul:1,this.pad="undefined"!=typeof t.pad?t.pad:0;for(var e=0;e<t.filters.length;e++){var i=new s(0,0,0,0);i.fromJSON(t.filters[e]),this.filters.push(i)}this.biases=new s(0,0,0,0),this.biases.fromJSON(t.biases)}};var i=function(t){var t=t||{};this.out_depth="undefined"!=typeof t.num_neurons?t.num_neurons:t.filters,this.l1_decay_mul="undefined"!=typeof t.l1_decay_mul?t.l1_decay_mul:0,this.l2_decay_mul="undefined"!=typeof t.l2_decay_mul?t.l2_decay_mul:1,this.num_inputs=t.in_sx*t.in_sy*t.in_depth,this.out_sx=1,this.out_sy=1,this.layer_type="fc";var e="undefined"!=typeof t.bias_pref?t.bias_pref:0;this.filters=[];for(var i=0;i<this.out_depth;i++)this.filters.push(new s(1,1,this.num_inputs));this.biases=new s(1,1,this.out_depth,e)};i.prototype={forward:function(t,e){this.in_act=t;for(var i=new s(1,1,this.out_depth,0),a=t.w,r=0;r<this.out_depth;r++){for(var h=0,n=this.filters[r].w,o=0;o<this.num_inputs;o++)h+=a[o]*n[o];h+=this.biases.w[r],i.w[r]=h}return this.out_act=i,this.out_act},backward:function(){var s=this.in_act;s.dw=t.zeros(s.w.length);for(var e=0;e<this.out_depth;e++){for(var i=this.filters[e],a=this.out_act.dw[e],r=0;r<this.num_inputs;r++)s.dw[r]+=i.w[r]*a,i.dw[r]+=s.w[r]*a;this.biases.dw[e]+=a}},getParamsAndGrads:function(){for(var t=[],s=0;s<this.out_depth;s++)t.push({params:this.filters[s].w,grads:this.filters[s].dw,l1_decay_mul:this.l1_decay_mul,l2_decay_mul:this.l2_decay_mul});return t.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0}),t},toJSON:function(){var t={};t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.num_inputs=this.num_inputs,t.l1_decay_mul=this.l1_decay_mul,t.l2_decay_mul=this.l2_decay_mul,t.filters=[];for(var s=0;s<this.filters.length;s++)t.filters.push(this.filters[s].toJSON());return t.biases=this.biases.toJSON(),t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.num_inputs=t.num_inputs,this.l1_decay_mul="undefined"!=typeof t.l1_decay_mul?t.l1_decay_mul:1,this.l2_decay_mul="undefined"!=typeof t.l2_decay_mul?t.l2_decay_mul:1,this.filters=[];for(var e=0;e<t.filters.length;e++){var i=new s(0,0,0,0);i.fromJSON(t.filters[e]),this.filters.push(i)}this.biases=new s(0,0,0,0),this.biases.fromJSON(t.biases)}},t.ConvLayer=e,t.FullyConnLayer=i}(convnetjs),function(t){"use strict";var s=t.Vol,e=function(s){var s=s||{};this.sx=s.sx,this.in_depth=s.in_depth,this.in_sx=s.in_sx,this.in_sy=s.in_sy,this.sy="undefined"!=typeof s.sy?s.sy:this.sx,this.stride="undefined"!=typeof s.stride?s.stride:2,this.pad="undefined"!=typeof s.pad?s.pad:0,this.out_depth=this.in_depth,this.out_sx=Math.floor((this.in_sx+2*this.pad-this.sx)/this.stride+1),this.out_sy=Math.floor((this.in_sy+2*this.pad-this.sy)/this.stride+1),this.layer_type="pool",this.switchx=t.zeros(this.out_sx*this.out_sy*this.out_depth),this.switchy=t.zeros(this.out_sx*this.out_sy*this.out_depth)};e.prototype={forward:function(t,e){this.in_act=t;for(var i=new s(this.out_sx,this.out_sy,this.out_depth,0),a=0,r=0;r<this.out_depth;r++)for(var h=-this.pad,n=-this.pad,o=0;o<this.out_sx;h+=this.stride,o++){n=-this.pad;for(var u=0;u<this.out_sy;n+=this.stride,u++){for(var _=-99999,d=-1,p=-1,f=0;f<this.sx;f++)for(var l=0;l<this.sy;l++){var y=n+l,c=h+f;if(y>=0&&y<t.sy&&c>=0&&c<t.sx){var m=t.get(c,y,r);m>_&&(_=m,d=c,p=y)}}this.switchx[a]=d,this.switchy[a]=p,a++,i.set(o,u,r,_)}}return this.out_act=i,this.out_act},backward:function(){var s=this.in_act;s.dw=t.zeros(s.w.length);for(var e=(this.out_act,0),i=0;i<this.out_depth;i++)for(var a=-this.pad,r=-this.pad,h=0;h<this.out_sx;a+=this.stride,h++){r=-this.pad;for(var n=0;n<this.out_sy;r+=this.stride,n++){var o=this.out_act.get_grad(h,n,i);s.add_grad(this.switchx[e],this.switchy[e],i,o),e++}}},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.sx=this.sx,t.sy=this.sy,t.stride=this.stride,t.in_depth=this.in_depth,t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.pad=this.pad,t},fromJSON:function(s){this.out_depth=s.out_depth,this.out_sx=s.out_sx,this.out_sy=s.out_sy,this.layer_type=s.layer_type,this.sx=s.sx,this.sy=s.sy,this.stride=s.stride,this.in_depth=s.in_depth,this.pad="undefined"!=typeof s.pad?s.pad:0,this.switchx=t.zeros(this.out_sx*this.out_sy*this.out_depth),this.switchy=t.zeros(this.out_sx*this.out_sy*this.out_depth)}},t.PoolLayer=e}(convnetjs),function(t){"use strict";var s=(t.Vol,t.getopt),e=function(t){var t=t||{};this.out_depth=s(t,["out_depth","depth"],0),this.out_sx=s(t,["out_sx","sx","width"],1),this.out_sy=s(t,["out_sy","sy","height"],1),this.layer_type="input"};e.prototype={forward:function(t,s){return this.in_act=t,this.out_act=t,this.out_act},backward:function(){},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type}},t.InputLayer=e}(convnetjs),function(t){"use strict";var s=t.Vol,e=function(t){var t=t||{};this.num_inputs=t.in_sx*t.in_sy*t.in_depth,this.out_depth=this.num_inputs,this.out_sx=1,this.out_sy=1,this.layer_type="softmax"};e.prototype={forward:function(e,i){this.in_act=e;for(var a=new s(1,1,this.out_depth,0),r=e.w,h=e.w[0],n=1;n<this.out_depth;n++)r[n]>h&&(h=r[n]);for(var o=t.zeros(this.out_depth),u=0,n=0;n<this.out_depth;n++){var _=Math.exp(r[n]-h);u+=_,o[n]=_}for(var n=0;n<this.out_depth;n++)o[n]/=u,a.w[n]=o[n];return this.es=o,this.out_act=a,this.out_act},backward:function(s){var e=this.in_act;e.dw=t.zeros(e.w.length);for(var i=0;i<this.out_depth;i++){var a=i===s?1:0,r=-(a-this.es[i]);e.dw[i]=r}return-Math.log(this.es[s])},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.num_inputs=this.num_inputs,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.num_inputs=t.num_inputs}};var i=function(t){var t=t||{};this.num_inputs=t.in_sx*t.in_sy*t.in_depth,this.out_depth=this.num_inputs,this.out_sx=1,this.out_sy=1,this.layer_type="regression"};i.prototype={forward:function(t,s){return this.in_act=t,this.out_act=t,t},backward:function(s){var e=this.in_act;e.dw=t.zeros(e.w.length);var i=0;if(s instanceof Array||s instanceof Float64Array)for(var a=0;a<this.out_depth;a++){var r=e.w[a]-s[a];e.dw[a]=r,i+=.5*r*r}else if("number"==typeof s){var r=e.w[0]-s;e.dw[0]=r,i+=.5*r*r}else{var a=s.dim,h=s.val,r=e.w[a]-h;e.dw[a]=r,i+=.5*r*r}return i},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.num_inputs=this.num_inputs,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.num_inputs=t.num_inputs}};var a=function(t){var t=t||{};this.num_inputs=t.in_sx*t.in_sy*t.in_depth,this.out_depth=this.num_inputs,this.out_sx=1,this.out_sy=1,this.layer_type="svm"};a.prototype={forward:function(t,s){return this.in_act=t,this.out_act=t,t},backward:function(s){var e=this.in_act;e.dw=t.zeros(e.w.length);for(var i=e.w[s],a=1,r=0,h=0;h<this.out_depth;h++)if(s!==h){var n=-i+e.w[h]+a;n>0&&(e.dw[h]+=1,e.dw[s]-=1,r+=n)}return r},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.num_inputs=this.num_inputs,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.num_inputs=t.num_inputs}},t.RegressionLayer=i,t.SoftmaxLayer=e,t.SVMLayer=a}(convnetjs),function(t){"use strict";function s(t){var s=Math.exp(2*t);return(s-1)/(s+1)}var e=t.Vol,i=function(t){var t=t||{};this.out_sx=t.in_sx,this.out_sy=t.in_sy,this.out_depth=t.in_depth,this.layer_type="relu"};i.prototype={forward:function(t,s){this.in_act=t;for(var e=t.clone(),i=t.w.length,a=e.w,r=0;i>r;r++)a[r]<0&&(a[r]=0);return this.out_act=e,this.out_act},backward:function(){var s=this.in_act,e=this.out_act,i=s.w.length;s.dw=t.zeros(i);for(var a=0;i>a;a++)e.w[a]<=0?s.dw[a]=0:s.dw[a]=e.dw[a]},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type}};var a=function(t){var t=t||{};this.out_sx=t.in_sx,this.out_sy=t.in_sy,this.out_depth=t.in_depth,this.layer_type="sigmoid"};a.prototype={forward:function(t,s){this.in_act=t;for(var e=t.cloneAndZero(),i=t.w.length,a=e.w,r=t.w,h=0;i>h;h++)a[h]=1/(1+Math.exp(-r[h]));return this.out_act=e,this.out_act},backward:function(){var s=this.in_act,e=this.out_act,i=s.w.length;s.dw=t.zeros(i);for(var a=0;i>a;a++){var r=e.w[a];s.dw[a]=r*(1-r)*e.dw[a]}},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type}};var r=function(s){var s=s||{};this.group_size="undefined"!=typeof s.group_size?s.group_size:2,this.out_sx=s.in_sx,this.out_sy=s.in_sy,this.out_depth=Math.floor(s.in_depth/this.group_size),this.layer_type="maxout",this.switches=t.zeros(this.out_sx*this.out_sy*this.out_depth)};r.prototype={forward:function(t,s){this.in_act=t;var i=this.out_depth,a=new e(this.out_sx,this.out_sy,this.out_depth,0);if(1===this.out_sx&&1===this.out_sy)for(var r=0;i>r;r++){for(var h=r*this.group_size,n=t.w[h],o=0,u=1;u<this.group_size;u++){var _=t.w[h+u];_>n&&(n=_,o=u)}a.w[r]=n,this.switches[r]=h+o}else for(var d=0,p=0;p<t.sx;p++)for(var f=0;f<t.sy;f++)for(var r=0;i>r;r++){for(var h=r*this.group_size,n=t.get(p,f,h),o=0,u=1;u<this.group_size;u++){var _=t.get(p,f,h+u);_>n&&(n=_,o=u)}a.set(p,f,r,n),this.switches[d]=h+o,d++}return this.out_act=a,this.out_act},backward:function(){var s=this.in_act,e=this.out_act,i=this.out_depth;if(s.dw=t.zeros(s.w.length),1===this.out_sx&&1===this.out_sy)for(var a=0;i>a;a++){var r=e.dw[a];s.dw[this.switches[a]]=r}else for(var h=0,n=0;n<e.sx;n++)for(var o=0;o<e.sy;o++)for(var a=0;i>a;a++){var r=e.get_grad(n,o,a);s.set_grad(n,o,this.switches[h],r),h++}},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.group_size=this.group_size,t},fromJSON:function(s){this.out_depth=s.out_depth,this.out_sx=s.out_sx,this.out_sy=s.out_sy,this.layer_type=s.layer_type,this.group_size=s.group_size,this.switches=t.zeros(this.group_size)}};var h=function(t){var t=t||{};this.out_sx=t.in_sx,this.out_sy=t.in_sy,this.out_depth=t.in_depth,this.layer_type="tanh"};h.prototype={forward:function(t,e){this.in_act=t;for(var i=t.cloneAndZero(),a=t.w.length,r=0;a>r;r++)i.w[r]=s(t.w[r]);return this.out_act=i,this.out_act},backward:function(){var s=this.in_act,e=this.out_act,i=s.w.length;s.dw=t.zeros(i);for(var a=0;i>a;a++){var r=e.w[a];s.dw[a]=(1-r*r)*e.dw[a]}},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type}},t.TanhLayer=h,t.MaxoutLayer=r,t.ReluLayer=i,t.SigmoidLayer=a}(convnetjs),function(t){"use strict";var s=(t.Vol,function(s){var s=s||{};this.out_sx=s.in_sx,this.out_sy=s.in_sy,this.out_depth=s.in_depth,this.layer_type="dropout",this.drop_prob="undefined"!=typeof s.drop_prob?s.drop_prob:.5,this.dropped=t.zeros(this.out_sx*this.out_sy*this.out_depth)});s.prototype={forward:function(t,s){this.in_act=t,"undefined"==typeof s&&(s=!1);var e=t.clone(),i=t.w.length;if(s)for(var a=0;i>a;a++)Math.random()<this.drop_prob?(e.w[a]=0,this.dropped[a]=!0):this.dropped[a]=!1;else for(var a=0;i>a;a++)e.w[a]*=this.drop_prob;return this.out_act=e,this.out_act},backward:function(){var s=this.in_act,e=this.out_act,i=s.w.length;s.dw=t.zeros(i);for(var a=0;i>a;a++)this.dropped[a]||(s.dw[a]=e.dw[a])},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.out_depth=this.out_depth,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.layer_type=this.layer_type,t.drop_prob=this.drop_prob,t},fromJSON:function(t){this.out_depth=t.out_depth,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.layer_type=t.layer_type,this.drop_prob=t.drop_prob}},t.DropoutLayer=s}(convnetjs),function(t){"use strict";var s=(t.Vol,function(t){var t=t||{};this.k=t.k,this.n=t.n,this.alpha=t.alpha,this.beta=t.beta,this.out_sx=t.in_sx,this.out_sy=t.in_sy,this.out_depth=t.in_depth,this.layer_type="lrn",this.n%2===0&&console.log("WARNING n should be odd for LRN layer")});s.prototype={forward:function(t,s){this.in_act=t;var e=t.cloneAndZero();this.S_cache_=t.cloneAndZero();for(var i=Math.floor(this.n/2),a=0;a<t.sx;a++)for(var r=0;r<t.sy;r++)for(var h=0;h<t.depth;h++){for(var n=t.get(a,r,h),o=0,u=Math.max(0,h-i);u<=Math.min(h+i,t.depth-1);u++){var _=t.get(a,r,u);o+=_*_}o*=this.alpha/this.n,o+=this.k,this.S_cache_.set(a,r,h,o),o=Math.pow(o,this.beta),e.set(a,r,h,n/o)}return this.out_act=e,this.out_act},backward:function(){var s=this.in_act;s.dw=t.zeros(s.w.length);for(var e=(this.out_act,Math.floor(this.n/2)),i=0;i<s.sx;i++)for(var a=0;a<s.sy;a++)for(var r=0;r<s.depth;r++)for(var h=this.out_act.get_grad(i,a,r),n=this.S_cache_.get(i,a,r),o=Math.pow(n,this.beta),u=o*o,_=Math.max(0,r-e);_<=Math.min(r+e,s.depth-1);_++){var d=s.get(i,a,_),p=-d*this.beta*Math.pow(n,this.beta-1)*this.alpha/this.n*2*d;_===r&&(p+=o),p/=u,p*=h,s.add_grad(i,a,_,p)}},getParamsAndGrads:function(){return[]},toJSON:function(){var t={};return t.k=this.k,t.n=this.n,t.alpha=this.alpha,t.beta=this.beta,t.out_sx=this.out_sx,t.out_sy=this.out_sy,t.out_depth=this.out_depth,t.layer_type=this.layer_type,t},fromJSON:function(t){this.k=t.k,this.n=t.n,this.alpha=t.alpha,this.beta=t.beta,this.out_sx=t.out_sx,this.out_sy=t.out_sy,this.out_depth=t.out_depth,this.layer_type=t.layer_type}},t.LocalResponseNormalizationLayer=s}(convnetjs),function(t){"use strict";var s=(t.Vol,t.assert),e=function(t){this.layers=[]};e.prototype={makeLayers:function(e){s(e.length>=2,"Error! At least one input layer and one loss layer are required."),s("input"===e[0].type,"Error! First layer must be the input layer, to declare size of inputs");var i=function(){for(var t=[],s=0;s<e.length;s++){var i=e[s];if(("softmax"===i.type||"svm"===i.type)&&t.push({type:"fc",num_neurons:i.num_classes}),"regression"===i.type&&t.push({type:"fc",num_neurons:i.num_neurons}),"fc"!==i.type&&"conv"!==i.type||"undefined"!=typeof i.bias_pref||(i.bias_pref=0,"undefined"!=typeof i.activation&&"relu"===i.activation&&(i.bias_pref=.1)),t.push(i),"undefined"!=typeof i.activation)if("relu"===i.activation)t.push({type:"relu"});else if("sigmoid"===i.activation)t.push({type:"sigmoid"});else if("tanh"===i.activation)t.push({type:"tanh"});else if("maxout"===i.activation){var a="undefined"!==i.group_size?i.group_size:2;t.push({type:"maxout",group_size:a})}else console.log("ERROR unsupported activation "+i.activation);"undefined"!=typeof i.drop_prob&&"dropout"!==i.type&&t.push({type:"dropout",drop_prob:i.drop_prob})}return t};e=i(e),this.layers=[];for(var a=0;a<e.length;a++){var r=e[a];if(a>0){var h=this.layers[a-1];r.in_sx=h.out_sx,r.in_sy=h.out_sy,r.in_depth=h.out_depth}switch(r.type){case"fc":this.layers.push(new t.FullyConnLayer(r));break;case"lrn":this.layers.push(new t.LocalResponseNormalizationLayer(r));break;case"dropout":this.layers.push(new t.DropoutLayer(r));break;case"input":this.layers.push(new t.InputLayer(r));break;case"softmax":this.layers.push(new t.SoftmaxLayer(r));break;case"regression":this.layers.push(new t.RegressionLayer(r));break;case"conv":this.layers.push(new t.ConvLayer(r));break;case"pool":this.layers.push(new t.PoolLayer(r));break;case"relu":this.layers.push(new t.ReluLayer(r));break;case"sigmoid":this.layers.push(new t.SigmoidLayer(r));break;case"tanh":this.layers.push(new t.TanhLayer(r));break;case"maxout":this.layers.push(new t.MaxoutLayer(r));break;case"svm":this.layers.push(new t.SVMLayer(r));break;default:console.log("ERROR: UNRECOGNIZED LAYER TYPE: "+r.type)}}},forward:function(t,s){"undefined"==typeof s&&(s=!1);for(var e=this.layers[0].forward(t,s),i=1;i<this.layers.length;i++)e=this.layers[i].forward(e,s);return e},getCostLoss:function(t,s){this.forward(t,!1);var e=this.layers.length,i=this.layers[e-1].backward(s);return i},backward:function(t){for(var s=this.layers.length,e=this.layers[s-1].backward(t),i=s-2;i>=0;i--)this.layers[i].backward();return e},getParamsAndGrads:function(){for(var t=[],s=0;s<this.layers.length;s++)for(var e=this.layers[s].getParamsAndGrads(),i=0;i<e.length;i++)t.push(e[i]);return t},getPrediction:function(){var t=this.layers[this.layers.length-1];s("softmax"===t.layer_type,"getPrediction function assumes softmax as last layer of the net!");for(var e=t.out_act.w,i=e[0],a=0,r=1;r<e.length;r++)e[r]>i&&(i=e[r],a=r);return a},toJSON:function(){var t={};t.layers=[];for(var s=0;s<this.layers.length;s++)t.layers.push(this.layers[s].toJSON());return t},fromJSON:function(s){this.layers=[];for(var e=0;e<s.layers.length;e++){var i,a=s.layers[e],r=a.layer_type;"input"===r&&(i=new t.InputLayer),"relu"===r&&(i=new t.ReluLayer),"sigmoid"===r&&(i=new t.SigmoidLayer),"tanh"===r&&(i=new t.TanhLayer),"dropout"===r&&(i=new t.DropoutLayer),"conv"===r&&(i=new t.ConvLayer),"pool"===r&&(i=new t.PoolLayer),"lrn"===r&&(i=new t.LocalResponseNormalizationLayer),"softmax"===r&&(i=new t.SoftmaxLayer),"regression"===r&&(i=new t.RegressionLayer),"fc"===r&&(i=new t.FullyConnLayer),"maxout"===r&&(i=new t.MaxoutLayer),"svm"===r&&(i=new t.SVMLayer),i.fromJSON(a),this.layers.push(i)}}},t.Net=e}(convnetjs),function(t){"use strict";var s=(t.Vol,function(t,s){this.net=t;var s=s||{};this.learning_rate="undefined"!=typeof s.learning_rate?s.learning_rate:.01,this.l1_decay="undefined"!=typeof s.l1_decay?s.l1_decay:0,this.l2_decay="undefined"!=typeof s.l2_decay?s.l2_decay:0,this.batch_size="undefined"!=typeof s.batch_size?s.batch_size:1,this.method="undefined"!=typeof s.method?s.method:"sgd",this.momentum="undefined"!=typeof s.momentum?s.momentum:.9,this.ro="undefined"!=typeof s.ro?s.ro:.95,this.eps="undefined"!=typeof s.eps?s.eps:1e-8,this.beta1="undefined"!=typeof s.beta1?s.beta1:.9,this.beta2="undefined"!=typeof s.beta2?s.beta2:.999,this.lambda="undefined"!=typeof s.lambda?s.lambda:1-1e-8,this.k=0,this.gsum=[],this.xsum=[]});s.prototype={train:function(s,e){var i=(new Date).getTime();this.net.forward(s,!0);var a=(new Date).getTime(),r=a-i,i=(new Date).getTime(),h=this.net.backward(e),n=0,o=0,a=(new Date).getTime(),u=a-i;if(this.k++,this.k%this.batch_size===0){var _=this.net.getParamsAndGrads();if(0===this.gsum.length&&("sgd"!==this.method||this.momentum>0))for(var d=0;d<_.length;d++)this.gsum.push(t.zeros(_[d].params.length)),"adam"===this.method||"adadelta"===this.method?this.xsum.push(t.zeros(_[d].params.length)):this.xsum.push([]);for(var d=0;d<_.length;d++)for(var p=_[d],f=p.params,l=p.grads,y="undefined"!=typeof p.l2_decay_mul?p.l2_decay_mul:1,c="undefined"!=typeof p.l1_decay_mul?p.l1_decay_mul:1,m=this.l2_decay*y,v=this.l1_decay*c,w=f.length,x=0;w>x;x++){n+=m*f[x]*f[x]/2,o+=v*Math.abs(f[x]);var g=v*(f[x]>0?1:-1),b=m*f[x],z=(b+g+l[x])/this.batch_size,S=this.gsum[d],N=this.xsum[d];if("adam"===this.method){var k=this.beta1*Math.pow(this.lambda,this.k-1);S[x]=S[x]*k+(1-k)*z,N[x]=N[x]*this.beta2+(1-this.beta2)*z*z;var L=Math.sqrt(N[x])+this.eps,M=1-Math.pow(this.beta1,this.k),O=1-Math.pow(this.beta2,this.k),J=this.learning_rate*Math.sqrt(O)/M,A=J*S[x]/L;f[x]+=A}else if("adagrad"===this.method){S[x]=S[x]+z*z;var A=-this.learning_rate/Math.sqrt(S[x]+this.eps)*z;f[x]+=A}else if("windowgrad"===this.method){S[x]=this.ro*S[x]+(1-this.ro)*z*z;var A=-this.learning_rate/Math.sqrt(S[x]+this.eps)*z;f[x]+=A}else if("adadelta"===this.method){S[x]=this.ro*S[x]+(1-this.ro)*z*z;var A=-Math.sqrt((N[x]+this.eps)/(S[x]+this.eps))*z;N[x]=this.ro*N[x]+(1-this.ro)*A*A,f[x]+=A}else if("nesterov"===this.method){var A=S[x];S[x]=S[x]*this.momentum+this.learning_rate*z,A=this.momentum*A-(1+this.momentum)*S[x],f[x]+=A}else if(this.momentum>0){var A=this.momentum*S[x]-this.learning_rate*z;S[x]=A,f[x]+=A}else f[x]+=-this.learning_rate*z;l[x]=0}}return{fwd_time:r,bwd_time:u,l2_decay_loss:n,l1_decay_loss:o,cost_loss:h,softmax_loss:h,loss:h+o+n}}},t.Trainer=s,t.SGDTrainer=s}(convnetjs),function(t){"use strict";var s=t.randf,e=t.randi,i=t.Net,a=t.Trainer,r=t.maxmin,h=t.randperm,n=t.weightedSample,o=t.getopt,u=t.arrUnique,_=function(t,s,e){var e=e||{};"undefined"==typeof t&&(t=[]),"undefined"==typeof s&&(s=[]),this.data=t,this.labels=s,this.train_ratio=o(e,"train_ratio",.7),this.num_folds=o(e,"num_folds",10),this.num_candidates=o(e,"num_candidates",50),this.num_epochs=o(e,"num_epochs",50),this.ensemble_size=o(e,"ensemble_size",10),this.batch_size_min=o(e,"batch_size_min",10),this.batch_size_max=o(e,"batch_size_max",300),this.l2_decay_min=o(e,"l2_decay_min",-4),this.l2_decay_max=o(e,"l2_decay_max",2),this.learning_rate_min=o(e,"learning_rate_min",-4),this.learning_rate_max=o(e,"learning_rate_max",0),this.momentum_min=o(e,"momentum_min",.9),this.momentum_max=o(e,"momentum_max",.9),this.neurons_min=o(e,"neurons_min",5),this.neurons_max=o(e,"neurons_max",30),this.folds=[],this.candidates=[],this.evaluated_candidates=[],this.unique_labels=u(s),this.iter=0,this.foldix=0,this.finish_fold_callback=null,this.finish_batch_callback=null,this.data.length>0&&(this.sampleFolds(),this.sampleCandidates())};_.prototype={sampleFolds:function(){var t=this.data.length,s=Math.floor(this.train_ratio*t);this.folds=[];for(var e=0;e<this.num_folds;e++){var i=h(t);this.folds.push({train_ix:i.slice(0,s),test_ix:i.slice(s,t)})}},sampleCandidate:function(){var t=this.data[0].w.length,r=this.unique_labels.length,h=[];h.push({type:"input",out_sx:1,out_sy:1,out_depth:t});for(var o=n([0,1,2,3],[.2,.3,.3,.2]),u=0;o>u;u++){var _=e(this.neurons_min,this.neurons_max),d=["tanh","maxout","relu"][e(0,3)];if(s(0,1)<.5){var p=Math.random();h.push({type:"fc",num_neurons:_,activation:d,drop_prob:p})}else h.push({type:"fc",num_neurons:_,activation:d})}h.push({type:"softmax",num_classes:r});var f=new i;f.makeLayers(h);var l,y=e(this.batch_size_min,this.batch_size_max),c=Math.pow(10,s(this.l2_decay_min,this.l2_decay_max)),m=Math.pow(10,s(this.learning_rate_min,this.learning_rate_max)),v=s(this.momentum_min,this.momentum_max),w=s(0,1);l=.33>w?{method:"adadelta",batch_size:y,l2_decay:c}:.66>w?{method:"adagrad",learning_rate:m,batch_size:y,l2_decay:c}:{method:"sgd",learning_rate:m,momentum:v,batch_size:y,l2_decay:c};var x=new a(f,l),g={};return g.acc=[],g.accv=0,g.layer_defs=h,g.trainer_def=l,g.net=f,g.trainer=x,g},sampleCandidates:function(){this.candidates=[];for(var t=0;t<this.num_candidates;t++){var s=this.sampleCandidate();this.candidates.push(s)}},step:function(){this.iter++;for(var t=this.folds[this.foldix],s=t.train_ix[e(0,t.train_ix.length)],r=0;r<this.candidates.length;r++){var h=this.data[s],n=this.labels[s];this.candidates[r].trainer.train(h,n)}var o=this.num_epochs*t.train_ix.length;if(this.iter>=o){for(var u=this.evalValErrors(),r=0;r<this.candidates.length;r++){var _=this.candidates[r];_.acc.push(u[r]),_.accv+=u[r]}if(this.iter=0,this.foldix++,null!==this.finish_fold_callback&&this.finish_fold_callback(),this.foldix>=this.folds.length){for(var r=0;r<this.candidates.length;r++)this.evaluated_candidates.push(this.candidates[r]);this.evaluated_candidates.sort(function(t,s){return t.accv/t.acc.length>s.accv/s.acc.length?-1:1}),this.evaluated_candidates.length>3*this.ensemble_size&&(this.evaluated_candidates=this.evaluated_candidates.slice(0,3*this.ensemble_size)),null!==this.finish_batch_callback&&this.finish_batch_callback(),this.sampleCandidates(),this.foldix=0}else for(var r=0;r<this.candidates.length;r++){var _=this.candidates[r],d=new i;d.makeLayers(_.layer_defs);var p=new a(d,_.trainer_def);_.net=d,_.trainer=p}}},evalValErrors:function(){for(var t=[],s=this.folds[this.foldix],e=0;e<this.candidates.length;e++){for(var i=this.candidates[e].net,a=0,r=0;r<s.test_ix.length;r++){var h=this.data[s.test_ix[r]],n=this.labels[s.test_ix[r]];i.forward(h);var o=i.getPrediction();a+=o===n?1:0}a/=s.test_ix.length,t.push(a)}return t},predict_soft:function(t){var s=[],e=0;0===this.evaluated_candidates.length?(e=this.candidates.length,
s=this.candidates):(e=Math.min(this.ensemble_size,this.evaluated_candidates.length),s=this.evaluated_candidates);for(var i,a,r=0;e>r;r++){var h=s[r].net,n=h.forward(t);if(0===r)i=n,a=n.w.length;else for(var o=0;a>o;o++)i.w[o]+=n.w[o]}for(var o=0;a>o;o++)i.w[o]/=e;return i},predict:function(t){var s=this.predict_soft(t);if(0!==s.w.length)var e=r(s.w),i=e.maxi;else var i=-1;return i},toJSON:function(){var t=Math.min(this.ensemble_size,this.evaluated_candidates.length),s={};s.nets=[];for(var e=0;t>e;e++)s.nets.push(this.evaluated_candidates[e].net.toJSON());return s},fromJSON:function(t){this.ensemble_size=t.nets.length,this.evaluated_candidates=[];for(var s=0;s<this.ensemble_size;s++){var e=new i;e.fromJSON(t.nets[s]);var a={};a.net=e,this.evaluated_candidates.push(a)}},onFinishFold:function(t){this.finish_fold_callback=t},onFinishBatch:function(t){this.finish_batch_callback=t}},t.MagicNet=_}(convnetjs),function(t){"use strict";"undefined"==typeof module||"undefined"==typeof module.exports?window.convnetjs=t:module.exports=t}(convnetjs);